<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SmartRosary Web Installer</title>
    <meta name="description" content="Easily install SmartRosary firmware on the web." />
    <meta name="viewport" content="width=device-width" />
    <meta name="color-scheme" content="dark light" />
    <style>
      body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif; padding: 0; margin: 0; line-height: 1.4; }
      .content { max-width: 600px; margin: 0 auto; padding: 12px; }
      h1 { margin-top: 1em; text-align: center; }
      h2 { margin-top: 1em; text-align: center; }
      a { color: #03a9f4; }
      .uploadBox { border-top: 1px solid #ccc; padding-bottom: 20px; }
      .uploadUSBBox { padding-bottom: 20px; }
      .uploadBtn { cursor: pointer; font-size: 14px; font-weight: 500; padding: 10px 24px; color: #fff; background-color: #03a9f4; border: none; border-radius: 9999px; }
      .footer{text-align: center;}
      .controls-container {display: flex; justify-content: center; margin-bottom: 1rem;}
      .controls-table {border-collapse: collapse;}
      .controls-table td {border: none;padding: 0.3rem 0.5rem;
      vertical-align: middle;
    }

    /* Fixed label width for alignment */
    label {
      display: inline-block;
      width: 100px;
    }
      #ProgressContainer { display: none; }
      #log { white-space: pre-wrap; background: #000; color: #fff; padding: 1em; height: 100px; overflow-y: scroll; margin-top:20px; display:none; }
    </style>
    <script type="module" src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js"></script>
  </head>
  <body>
    <div class="content">
      <h1>SmartRosary Web Installer</h1>
      <div class="uploadBox">
        <h2>Upload firmware v0.6 via USB</h2>
  <div class="controls-container">
    <table class="controls-table">
      <tr>
        <td><label for="language">Language:</label></td>
        <td>
          <select id="language">
            <option value="pl">Polski</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label for="intentions">Intentions:</label></td>
        <td>
          <select id="intentions">
            <option value="none">None</option>
            <option value="rosary">Żywy Różaniec 2025 (PMK Düsseldorf)</option>
          </select>
        </td>
      </tr>
    </table>
  </div>
        <p align="center"><esp-web-install-button></esp-web-install-button></p>
        <div class="footer">USB Installer powered by <a href="https://esphome.github.io/esp-web-tools/">ESP Web Tools</a>.</div>
      </div>
      <div class="uploadBox">
        <h2>Upload firmware v0.6 via OTA</h2>
        <div style="text-align: center; margin-top: 1em;"><button id="uploadFirmwareBtn" class="uploadBtn">Connect & Upload</button></div>
      </div>
      <div class="uploadBox">
        <h2>Upload language via OTA</h2>
        <div style="text-align: center; margin-top: 1em;">
          <select id="languageFileSelect">
            <option value="lang/nvs-lang-pl.bin">Polski</option>
            <option value="lang/nvs-lang-en.bin">English</option>
            <option value="lang/nvs-lang-de.bin">Deutsch</option>
          </select></div>
        <div style="text-align: center; margin-top: 1em;"><button id="uploadLanguageBtn" class="uploadBtn">Connect & Upload</button></div>
      </div>
      <div class="uploadBox">
        <h2>Upload intentions via OTA</h2>
        <div style="text-align: center; margin-top: 1em;">
          <select id="intentionsFileSelect">
            <option value="intentions/nvs-intentions-pmkdus-2025.bin">Żywy Różaniec 2025 (PMK Düsseldorf)</option>
            <!--<option value="firmware/nvs-intentions-pl-2024.bin">nvs-intentions-pl-2024.bin</option>-->
          </select></div>
        <div style="text-align: center; margin-top: 1em;"><button id="uploadIntentionsBtn" class="uploadBtn">Connect & Upload</button></div>
      </div>
      <div id="ProgressContainer"><progress id="progressBar" value="0" max="0" style="width:100%; margin:1em 0; height: 30px;"></progress><div style="display: flex; justify-content: center; align-items: center;"><span id="progressText">0%</span><span style="margin-left: 5px;" id="progressChunks">(0/0 Bytes)</span></div></div>
      <div id="log"></div>
    </div>
<script src="https://lib.arvancloud.ir/nosleep/0.9.0/NoSleep.min.js"></script>
<script>
  // 1) Screen Wake Lock API approach (modern browsers)
  let wakeLock = null;
  async function enableWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          console.log('Screen Wake Lock was released');
        });
        console.log('Screen Wake Lock is active');
      }
    } catch (err) {
      console.error('WakeLock error:', err.name, err.message);
    }
  }

  // 2) NoSleep.js fallback for older Android WebViews / browsers
  const noSleep = new NoSleep();
  function enableNoSleep() {
    noSleep.enable();
    console.log('NoSleep enabled');
  }

  // Master switch: call this in a user gesture (e.g. button click)
  function preventStandby() {
    enableWakeLock();
    enableNoSleep();
  }

  // Optional: re-acquire on page visibility change
  document.addEventListener('visibilitychange', () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
      enableWakeLock();
    }
  });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
      customElements.whenDefined("esp-web-install-button").then(() => {
        const btn     = document.querySelector("esp-web-install-button");
        const selLang = document.getElementById("language");
        const selInt  = document.getElementById("intentions");
        const origin  = window.location.origin;  // e.g. "http://127.0.0.1:5501"

        // these are your on‐disk locations under the project root:
        const firmwareParts = [
          { path: "smartrosary-web-installer/firmware/bootloader.bin", offset: 0x000000 },
          { path: "smartrosary-web-installer/firmware/partitions.bin", offset: 0x008000 },
          { path: "smartrosary-web-installer/firmware/boot_app0.bin",  offset: 0x00E000 },
          { path: "smartrosary-web-installer/firmware/firmware.bin",   offset: 0x010000 },
          { path: "smartrosary-web-installer/spiffs/wallpaper.bin",    offset: 0x2DF000 }
        ];

        const languages = {
          pl: { name: "Polski", path: "smartrosary-web-installer/lang/nvs-lang-pl.bin", offset: 0x2D5000 },
          en: { name: "English", path: "smartrosary-web-installer/lang/nvs-lang-en.bin", offset: 0x2D5000 },
          de: { name: "Deutsch", path: "smartrosary-web-installer/lang/nvs-lang-de.bin", offset: 0x2D5000 }
        };

        const intentions = {
          none: null,
          rosary: {
            name: "Żywy Różaniec 2025",
            path: "smartrosary-web-installer/intentions/nvs-intentions-pmkdus-2025.bin",
            offset: 0x2D0000
          }
        };

        function buildManifest() {
          // revoke old blob
          if (btn._blobUrl) URL.revokeObjectURL(btn._blobUrl);

          // start with firmware bits
          const rawParts = [...firmwareParts];

          // splice in language
          const lang = languages[selLang.value];
          rawParts.splice(1, 0, { path: lang.path, offset: lang.offset });

          // append intention if any
          const intent = intentions[selInt.value];
          if (intent) rawParts.push({ path: intent.path, offset: intent.offset });

          // convert every path into an absolute HTTP URL
          const parts = rawParts.map(p => ({
            offset: p.offset,
            path: p.path.startsWith("http")
              ? p.path
              : `${origin}/${p.path}`
          }));

          const manifest = {
            name:                     `SmartRosary (${lang.name}${intent ? " / " + intent.name : ""})`,
            version:                  "v0.6",
            funding_url:              "", 
            new_install_prompt_erase: true,
            builds: [
              {
                chipFamily: "ESP32-C3",
                improv:     false,
                parts
              }
            ]
          };

          const blobUrl = URL.createObjectURL(
            new Blob([JSON.stringify(manifest)], { type: "application/json" })
          );

          btn._blobUrl = blobUrl;
          btn.manifest = blobUrl;
          console.log("Using manifest blob URL:", blobUrl);
        }

        selLang.addEventListener("change", buildManifest);
        selInt .addEventListener("change", buildManifest);
        buildManifest();
      });
    });
  </script>

<script>
      const SERVICE_UUID       = '12345678-1234-5678-1234-56789abcdef0';
      const FIRMWARE_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef1';
      const INTENTS_CHAR_UUID  = '12345678-1234-5678-1234-56789abcde10';
      const LANG_CHAR_UUID     = '12345678-1234-5678-1234-56789abcde20';
      const STATUS_CHAR_UUID   = '12345678-1234-5678-1234-56789abcdef2';

      let device, writeChar, statusChar;
      let ready = true;
      const progressBar    = document.getElementById('progressBar');
      const progressText   = document.getElementById('progressText');
      const progressChunks = document.getElementById('progressChunks');

      document.getElementById('uploadFirmwareBtn').addEventListener('click', () => {preventStandby(); startFirmwareOTA();});
      document.getElementById('uploadIntentionsBtn').addEventListener('click', () => {preventStandby(); startIntentionsOTA();});
      document.getElementById('uploadLanguageBtn').addEventListener('click', () => {preventStandby(); startLanguageOTA();});

      function showProgressContainer() { document.getElementById('ProgressContainer').style.display = 'block'; }
      function hideProgressContainer() { document.getElementById('ProgressContainer').style.display = 'none'; }
      function crc32(buf) { let crc=0xFFFFFFFF; for(let b of buf){crc^=b; for(let i=0;i<8;i++) crc=(crc>>>1)^(0xEDB88320&-(crc&1));} return (crc^0xFFFFFFFF)>>>0; }
      async function waitReady(){while(!ready) await new Promise(r=>setTimeout(r,50)); ready=false;}
      function updateProgress(sent,total){progressBar.max=total;progressBar.value=sent;progressText.textContent=Math.round(sent/total*100)+'%';progressChunks.textContent=`(${sent}/${total} Bytes)`;}

      async function startFirmwareOTA(){
        const resp = await fetch('firmware/firmware.bin'); if(!resp.ok)return;
        const data = new Uint8Array(await resp.arrayBuffer());
        await connectBLE(SERVICE_UUID,FIRMWARE_CHAR_UUID);
        // send 4-byte size header
        const sizeBuf = new ArrayBuffer(4);
        new DataView(sizeBuf).setUint32(0,data.length,true);
        await writeChar.writeValue(sizeBuf);
        await waitReady();
        showProgressContainer(); updateProgress(0,data.length);
        // send chunks
        let offset=0, chunkSize=512-4;
        while(offset<data.length){
          const len=Math.min(chunkSize,data.length-offset);
          const chunk=data.slice(offset,offset+len);
          const crc=crc32(chunk);
          const packet=new Uint8Array(len+4);
          packet.set(chunk);
          new DataView(packet.buffer).setUint32(len,crc,true);
          await writeChar.writeValue(packet);
          await waitReady();
          offset+=len; updateProgress(offset,data.length);
        }
        hideProgressContainer(); console.log('Firmware upload complete.');
      }

      async function startIntentionsOTA(){
        const path=document.getElementById('intentionsFileSelect').value;
        const resp=await fetch(path); if(!resp.ok)return;
        const data=new Uint8Array(await resp.arrayBuffer());
        const filename = path.split('/').pop();
        await sendNVS(data,SERVICE_UUID,INTENTS_CHAR_UUID,filename);
      }

      async function startLanguageOTA(){
        const path=document.getElementById('languageFileSelect').value;
        const resp=await fetch(path); if(!resp.ok)return;
        const data=new Uint8Array(await resp.arrayBuffer());
        const filename = path.split('/').pop();
        await sendNVS(data,SERVICE_UUID,LANG_CHAR_UUID,filename);
      }

      async function sendNVS(data,svcUuid,charUuid,partition){
        await connectBLE(svcUuid,charUuid);
        // send filename header
        const name=new TextEncoder().encode(partition);
        await writeChar.writeValue(name);
        await waitReady();
        showProgressContainer(); updateProgress(0,data.length);
        let offset=0, chunkSize=320;
        while(offset<data.length){
          const len=Math.min(chunkSize,data.length-offset);
          const chunk=data.slice(offset,offset+len);
          const crc=crc32(chunk);
          const packet=new Uint8Array(len+4);
          packet.set(chunk);
          new DataView(packet.buffer).setUint32(len,crc,true);
          await writeChar.writeValue(packet);
          await waitReady();
          offset+=len; updateProgress(offset,data.length);
        }
        hideProgressContainer(); console.log(`${partition} upload complete.`);
      }

      async function connectBLE(svcUuid,charUuid){
        device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:'rosary'}],optionalServices:[svcUuid]});
        const srv=await device.gatt.connect();
        const svc=await srv.getPrimaryService(svcUuid);
        writeChar=await svc.getCharacteristic(charUuid);
        statusChar=await svc.getCharacteristic(STATUS_CHAR_UUID);
        statusChar.addEventListener('characteristicvaluechanged',()=>ready=true);
        await statusChar.startNotifications();
      }
    </script>
  </body>
</html>
